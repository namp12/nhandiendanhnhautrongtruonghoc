<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Violence Detection - Upload Video</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .drop-zone {
            border: 2px dashed #555;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background 0.3s;
            background: #1a1a1a;
        }
        .drop-zone.drag-over {
            border-color: #0d6efd;
            background: #0d1b35;
        }
        .drop-zone .icon { font-size: 3rem; }
        #videoPreview { max-width: 100%; border-radius: 8px; border: 2px solid #333; }
        .event-badge { font-size: 0.9rem; }
        .spinner-wrapper { display: none; }
        .result-section { display: none; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">üõ°Ô∏è Violence Detection</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Live Monitor</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/upload">Upload Video</a></li>
                    <li class="nav-item"><a class="nav-link" href="/history">History Logs</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h3>üìÅ Upload & Analyze Video</h3>
        <p class="text-muted">T·∫£i video l√™n ƒë·ªÉ AI ph√¢n t√≠ch v√† ph√°t hi·ªán c√°c h√†nh vi nguy hi·ªÉm.</p>

        <!-- Drop Zone -->
        <div class="drop-zone" id="dropZone">
            <div class="icon">üé¨</div>
            <h5 class="mt-2">K√©o th·∫£ video v√†o ƒë√¢y ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn file</h5>
            <p class="text-muted small">H·ªó tr·ª£: MP4, AVI, MOV, MKV</p>
            <input type="file" id="fileInput" accept="video/*" style="display:none;">
        </div>

        <!-- Video Preview -->
        <div id="previewSection" class="mt-4" style="display:none;">
            <h5>üì∫ Preview</h5>
            <video id="videoPreview" controls></video>
            <div class="mt-3">
                <button class="btn btn-danger btn-lg" id="analyzeBtn">
                    üîé Ph√¢n T√≠ch Video
                </button>
            </div>
        </div>

        <!-- Spinner -->
        <div class="spinner-wrapper mt-4 text-center" id="spinnerWrapper">
            <div class="spinner-border text-primary" style="width:3rem;height:3rem;" role="status"></div>
            <p class="mt-2 text-muted">ƒêang ph√¢n t√≠ch video... c√≥ th·ªÉ m·∫•t v√†i ph√∫t.</p>
        </div>

        <!-- Results -->
        <div class="result-section mt-4" id="resultSection">
            <h5>üèÅ K·∫øt Qu·∫£ Ph√¢n T√≠ch</h5>
            <div id="summaryBox" class="alert" role="alert"></div>

            <table class="table table-dark table-hover mt-3" id="resultTable" style="display:none;">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Lo·∫°i S·ª± Ki·ªán</th>
                        <th>Th·ªùi ƒêi·ªÉm B·∫Øt ƒê·∫ßu</th>
                        <th>Th·ªùi ƒêi·ªÉm K·∫øt Th√∫c</th>
                        <th>Th·ªùi L∆∞·ª£ng</th>
                        <th>ƒê·ªô Tin C·∫≠y</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        const dropZone     = document.getElementById('dropZone');
        const fileInput    = document.getElementById('fileInput');
        const previewSec   = document.getElementById('previewSection');
        const videoPreview = document.getElementById('videoPreview');
        const analyzeBtn   = document.getElementById('analyzeBtn');
        const spinnerWrap  = document.getElementById('spinnerWrapper');
        const resultSec    = document.getElementById('resultSection');
        const summaryBox   = document.getElementById('summaryBox');
        const resultTable  = document.getElementById('resultTable');
        const resultBody   = document.getElementById('resultTableBody');

        let selectedFile = null;

        // Click to open file dialog
        dropZone.addEventListener('click', () => fileInput.click());

        // Drag & Drop events
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files[0]) handleFile(fileInput.files[0]);
        });

        function handleFile(file) {
            selectedFile = file;
            const url = URL.createObjectURL(file);
            videoPreview.src = url;
            previewSec.style.display = 'block';
            resultSec.style.display  = 'none';
        }

        analyzeBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            // Show spinner
            spinnerWrap.style.display = 'block';
            resultSec.style.display   = 'none';
            analyzeBtn.disabled       = true;

            const formData = new FormData();
            formData.append('video', selectedFile);

            try {
                const res  = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await res.json();

                spinnerWrap.style.display = 'none';
                resultSec.style.display   = 'block';
                analyzeBtn.disabled       = false;

                if (data.error) {
                    summaryBox.className = 'alert alert-danger';
                    summaryBox.textContent = '‚ùå L·ªói: ' + data.error;
                    return;
                }

                const events = data.events || [];
                if (events.length === 0) {
                    summaryBox.className = 'alert alert-success';
                    summaryBox.innerHTML = '‚úÖ <strong>Kh√¥ng ph√°t hi·ªán h√†nh vi ƒë√°nh nhau</strong> trong video n√†y!';
                    resultTable.style.display = 'none';
                } else {
                    summaryBox.className = 'alert alert-danger';
                    summaryBox.innerHTML = `‚ö†Ô∏è Ph√°t hi·ªán <strong>${events.length} s·ª± ki·ªán b·∫°o l·ª±c</strong>! ƒê√£ l∆∞u v√†o l·ªãch s·ª≠.`;

                    resultBody.innerHTML = '';
                    events.forEach((ev, i) => {
                        const row = `
                            <tr>
                                <td>${i + 1}</td>
                                <td><span class="badge bg-danger event-badge">${ev.event_type.toUpperCase()}</span></td>
                                <td>${ev.start_sec}s</td>
                                <td>${ev.end_sec}s</td>
                                <td>${ev.duration_seconds}s</td>
                                <td>${(ev.max_confidence * 100).toFixed(0)}%</td>
                            </tr>`;
                        resultBody.innerHTML += row;
                    });
                    resultTable.style.display = 'table';
                }
            } catch (err) {
                spinnerWrap.style.display = 'none';
                analyzeBtn.disabled       = false;
                summaryBox.className = 'alert alert-danger';
                summaryBox.textContent = '‚ùå L·ªói k·∫øt n·ªëi server: ' + err.message;
                resultSec.style.display = 'block';
            }
        });
    </script>
</body>
</html>
